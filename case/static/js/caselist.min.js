function insert_update_rank(celement,cnum){var cnum=arguments[1]?arguments[1]:1;var pelement=celement.prev();var rankdic={};var newrank=1;var classname=celement.attr("class");if(classname=="cmodule"){curpath=window.location.pathname;catid=curpath.replace(/[^0-9]/ig,"");if(catid==""){alert("非末级产品类目下不能对模块进行排序！");location.reload();return}else{var url="/case/haschildren/";var para={"pid":catid,};$.get(url,para,function(data){var rs=eval("("+data+")");if(rs.success){if(rs.haschildren){alert("非末级产品类目下不能对模块进行排序！");location.reload();return}}else{alert("判断失败")}})}}if(pelement.length==0||pelement.attr("class")!==celement.attr("class")){celement.attr("rank","1")}else{newrank=parseInt(pelement.attr("rank"))+1;celement.attr("rank",newrank)}var tempele=celement;for(var i=1;i<cnum;i++){tempele=tempele.next();newrank=newrank+1;tempele.attr("rank",newrank)}var cid=celement.attr("value");if(cid){rankdic[cid]=newrank}else{celement.find("input").eq(0).attr("checked","checked")}var nx=tempele.nextAll().filter("."+classname);var mid=0;if(classname=="mtr"){mid=-1}nx.each(function(){newrank=parseInt($(this).attr("rank"))+cnum;$(this).attr("rank",newrank);cid=$(this).attr("value");if(cid){rankdic[cid]=newrank}else{$(this).find("input").eq(0).attr("checked","checked")}});rankdic=JSON.stringify(rankdic);url="/case/updaterank/";para={"mid":mid,"rankdict":rankdic};$.post(url,para,function(data){var rs=eval("("+data+")");if(rs.success){}else{alert(rs.message)}})}function delete_update_rank(celement){var nextele=celement.next();var classname=celement.attr("class");if(nextele.length!==0||classname=="cmodule"){if(classname=="cmodule"){var ccase=celement.find(".mtr");var cnum=celement.prev().find(".mtr").last().attr("rank");mid=celement.prev().attr("value");var i=1;rankdic={};ccase.each(function(){var newrank=parseInt(cnum)+i;i=i+1;var cid=$(this).attr("value");$(this).attr("rank",newrank);if(cid){rankdic[cid]=newrank}else{$(this).find("input").eq(0).attr("checked","checked")}});rankdic=JSON.stringify(rankdic);url="/case/updaterank/";para={"mid":mid,"rankdict":rankdic};$.post(url,para,function(data){var rs=eval("("+data+")");if(rs.success){}else{alert(rs.message)}})}}}$(document).ready(function(){var casehtml='<tr class="mtr" value=""><td><input class="casecheck nodrag" type="checkbox" checked=\'checked\' name="checklist"></td>'+'<td class="editable nodrag"></td>'+'<td class="editable nodrag"></td>'+'<td class="editable nodrag"></td>'+'<td class="nodrag"><span class="level">2</span></td>'+'<td class="nodrag"><a class="icon-play-circle"></a></td>'+'<td class="editable nodrag"></td>'+"<td></td>"+"<td></td>"+'<td class="editable nodrag"></td>'+'<td class="nodrag">'+'<a class="icon-plus" title="添加用例"></a> '+'<a class="icon-download-alt" title="引入用例" href="#casePullModal" data-toggle="modal" id="pullbutton" onclick="pullPop(this)"></a> '+'<a class="icon-eye-open" title="查看结果"></a> '+'<a class="icon-trash"></a>'+"</td>"+"</tr>";var modulehtml='<tr class="cmodule">'+'<td colspan="11">'+"<div>"+"<table >"+"<tbody>"+'<tr class="success">'+'<td colspan="1"><input class="modulecheck" type="checkbox" checked=\'checked\' name="checklist"></td>'+'<td colspan="9" class="editable"></td>'+"<td >"+'<a class="icon-plus-sign" title="添加模块"></a> '+'<a class="icon-plus" title="添加用例"></a> '+'<a class="icon-trash"></a> '+"</td>"+"</tr>"+casehtml+"</tbody>"+"</table>"+"</div>"+"</td>"+"</tr>";var resulthtml='<select class="cresult">'+"<option>-</option>"+"<option>Pass</option>"+"<option>Fail</option>"+"<option>Block</option>"+"</select>";var levelhtml='<select class="lselect">'+"<option>1</option>"+"<option>2</option>"+"<option>3</option>"+"</select>";function scrollOffset(scroll_offset){var x=document.body.clientHeight;console.log("scroll_offset");console.log(x);$("body,html").animate({scrollTop:scroll_offset.top+x},500)}$("#newcase").click(function(){var newlast=$(".mtr").last();if(newlast.length==0){newlast=$(".success").last();newlast.after(casehtml)}else{newlast.after(casehtml)}newlast=$(".mtr").last();insert_update_rank(newlast);newlast.attr("id","newone");scrollOffset($("#newone").offset());newlast.removeAttr("id")});$("#newmodule").click(function(){var cmodule=$(".cmodule").last();cmodule.after(modulehtml);var newlast=cmodule.next();insert_update_rank(newlast.find(".mtr"));insert_update_rank(newlast);newlast.attr("id","newone");scrollOffset($("#newone").offset());newlast.removeAttr("id")});$(".editable").live("click",function(){var tdnode=$(this);var tdTest=tdnode.text();tdnode.attr("before",tdTest);var crs=tdnode.parent().children().eq(5).find("span");if(tdnode.hasClass("save")&&crs.length==0){}else{if(tdnode.find(".edittx").length==0){tdnode.empty();var tx=$("<textarea class='edittx'></textarea>");tx.attr("value",tdTest);tdnode.append(tx);tx.focus()}}});$(".edittx").live("blur",function(){var tx=$(this);var etext=tx.val();var tp=tx.parent();tx.remove();tp.attr("value",etext);tp.html(etext);if(tp.attr("before")!==etext){var tid=tp.parent().attr("value");var tname=tp.attr("name");
var crs=tp.parent().children().eq(5).find("span");if(tp.hasClass("save")&&tid&&crs.length){var url="/case/updateresult/";var para={"tname":tname,"tid":tid,"tcnt":etext};$.post(url,para,function(data){var rs=eval("("+data+")");if(rs.success){}else{alert(rs.message)}})}else{tp.siblings().eq(0).find("input").attr("checked","checked")}}});$(".level").live("click",function(){var tdnode=$(this).parent();var tdTest=$(this).text();tdnode.empty();var tx=$(levelhtml);tx.attr("value",tdTest);tdnode.append(tx)});$(".lselect").live("change",function(){var tx=$(this);var etext=tx.val();var tp=tx.parent();tx.remove();tp.attr("value",etext);tp.html("<span class='level'>"+etext+"</span>");tp.siblings().eq(0).find("input").attr("checked","checked")});$(".icon-play-circle").live("click",function(){var exeico=$(this);var caseid=exeico.parents(".mtr").attr("value");if(caseid!==""){exeico.next().remove();exeico.after(resulthtml);exeico.toggle()}});$(".cresult").live("change",function(){var rsdrop=$(this);var thiscell=rsdrop.parent();var exeico=$(this).prev();var result=rsdrop.val();if(result=="-"){return}var caseid=rsdrop.parents(".mtr").attr("value");exeico.toggle();url="/case/executecase/";para={"caseid":caseid,"cresult":result};$.post(url,para,function(data){var rs=eval("("+data+")");if(rs.success){rsdrop.before('<span class="'+result+'">&nbsp;'+result+"</span>");rsdrop.remove();thiscell.next().next().text(rs.exedetail.exec_date);thiscell.next().next().next().text(rs.exedetail.executor);thiscell.next().next().next().next().html("")}else{rsdrop.remove();alert(rs.message)}})});$(".icon-plus").live("click",function(){var ccase=$(this).parent().parent();ccase.after(casehtml);insert_update_rank(ccase.next())});$(".icon-plus-sign").live("click",function(){var cmodule=$(this).parents(".cmodule");cmodule.after(modulehtml);var newlast=cmodule.next();insert_update_rank(newlast.find(".mtr"));insert_update_rank(newlast);newlast.attr("id","newone");scrollOffset($("#newone").offset());newlast.removeAttr("id")});$(".icon-chevron-up").live("click",function(){var cdrop=$(this);cdrop.removeClass("icon-chevron-up");cdrop.addClass("icon-chevron-down");cdrop.parent().parent().nextAll().toggle()});$(".icon-chevron-down").live("click",function(){var cdrop=$(this);cdrop.removeClass("icon-chevron-down");cdrop.addClass("icon-chevron-up");cdrop.parent().parent().nextAll().toggle()});function checkall(master,slave){if(master.attr("checked")=="checked"){slave.each(function(){$(this).attr("checked","checked")})}else{slave.each(function(){$(this).removeAttr("checked")})}}$("#caseall").click(function(){var slave=$("#caselist").find("input");checkall($(this),slave)});$(".modulecheck").live("click",function(){var slave=$(this).parents(".cmodule").find("input");checkall($(this),slave)});function drag_update_rank(){insert_update_rank($(this))}$("#caselist tbody").dragsort({dragSelector:".cmodule",dragSelectorExclude:".nodrag",dragEnd:drag_update_rank,});$(".cmodule tbody").dragsort({dragSelector:".mtr",dragSelectorExclude:".nodrag",dragEnd:drag_update_rank,});$(".icon-trash").live("click",function(){if(confirm("你确定要删除吗？")){var node=$(this).parent().parent();if(node.attr("class")=="mtr"){var url="/case/deletecase/";var delid=node.attr("value");var para={"did":delid,};$.post(url,para,function(data,status){var rs=eval("("+data+")");if(rs.success){node.remove()}else{alert("删除失败")}})}else{var currentm=node.parents(".cmodule");var prevmodule=currentm.prev().find("tbody");if(prevmodule.length){var url="/case/moduledel/";var mid=currentm.attr("value");var para={"mid":mid,};if(mid==undefined){currentm.remove();return}delete_update_rank(currentm);var snode=node.siblings().clone(true);$.post(url,para,function(data,status){var rs=eval("("+data+")");if(rs.success){currentm.remove();prevmodule.append(snode)}else{alert("删除失败")}})}else{var nexrmodule=currentm.next();var chcase=currentm.find(".mtr");if(nexrmodule.length&&chcase.length==0){currentm.remove()}else{alert("抱歉~不能删除")}}}return true}else{return false}});$("#delbtn").click(function(){if(confirm("你确定要删除吗？")){var caseChk=$("input[class='casecheck nodrag']:checked");var delids="";$(caseChk).each(function(){delids+=$(this).parent().parent().attr("value");delids+=","});if(delids==""){alert("请勾选用例再点批量删除");return}$(this).attr("disabled","true");url="/case/deletecase/";para={"did":delids,};$.post(url,para,function(data,status){var rs=eval("("+data+")");if(rs.success){$(caseChk).each(function(){$(this).parent().parent().remove()})}else{alert("删除失败")}});$(this).removeAttr("disabled")}});var url="/case/casecate/";var areaJson;var temp_html;var category1=$(this).find(".category_select_1");var category2=$(this).find(".category_select_2");var category3=$(this).find(".category_select_3");var category_select_1=function(){var c1=$(".cate1").val();temp_html="<option>"+"全部"+"</option>";$.each(areaJson,function(i,category_select_1){temp_html+="<option value='"+category_select_1.masterid+"'>"+category_select_1.master+"</option>"});category1.html(temp_html);
var n=category1.get(0).selectedIndex;if(c1){$(".category_select_1 option[value="+c1+"]").attr("selected","true");var preoption=$(".category_select_1 option[value="+c1+"]").prevAll("option")}if(n!=0){if((areaJson[n-1].slist).length!=0){category2.show();category_select_2();$(".cate1").attr("value",category1.children().eq(preoption.length).val())}}else{if(n==0&&c1){if((areaJson[preoption.length-1].slist).length!=0){category2.show();category_select_2();$(".cate1").attr("value",category1.children().eq(preoption.length).val())}else{category2.hide();category3.hide()}}else{category2.hide();category3.hide()}}};var category_select_2=function(){var c2=$(".cate2").val();temp_html="<option>"+"请选择"+"</option>";var n=category1.get(0).selectedIndex;if(n==0){category2.css("display","none");category3.css("display","none")}else{if((areaJson[n-1].slist).length==0){category2.css("display","none");category3.css("display","none")}else{$.each(areaJson[n-1].slist,function(i,category_select_2){temp_html+="<option value='"+category_select_2.secondid+"'>"+category_select_2.second+"</option>"});category2.html(temp_html);if(c2){$(".category_select_2 option[value="+c2+"]").attr("selected","true")}category_select_3()}}};var category_select_3=function(){var c3=$(".cate3").val();temp_html="<option>"+"请选择"+"</option>";var m=category1.get(0).selectedIndex;var n=category2.get(0).selectedIndex;if(c3){category3.css("display","inline");$.each(areaJson[m-1].slist[n-1].thirdlist,function(i,category_select_3){temp_html+="<option value='"+category_select_3.thirdid+"'>"+category_select_3.third+"</option>"});category3.html(temp_html);$(".category_select_3 option[value="+c3+"]").attr("selected","true")}else{if(n!=0){if((areaJson[m-1].slist[n-1].thirdlist).length==0){category3.css("display","none")}else{category3.css("display","inline");$.each(areaJson[m-1].slist[n-1].thirdlist,function(i,category_select_3){temp_html+="<option value='"+category_select_3.thirdid+"'>"+category_select_3.third+"</option>"});category3.html(temp_html)}}else{category3.css("display","none")}}};category1.change(function(){var c1=$(".cate1").attr("value","");var c2=$(".cate2").attr("value","");var c3=$(".cate3").attr("value","");category2.show();category3.hide();category_select_2()});category2.change(function(){var c3=$(".cate3").attr("value","");category3.hide();category_select_3()});$.getJSON(url,function(data){areaJson=data;category_select_1()});$(".selectList select").live("click",function(){if($(this).val()!=="全部"&&$(this).val()!=="请选择"){$(".cate").attr("value",$(this).val());$(".next").attr("action","/case/caselist/"+$(this).val()+"/")}else{if($(this).val()=="请选择"){$(".cate").attr("value",$(this).prev().val());$(".next").attr("action","/case/caselist/"+$(this).prev().val()+"/");cateval=$(".cate").val();cate1val=$(".cate1").val();cate2val=$(".cate2").val();if(cateval==cate2val){$(".cate3").attr("value","")}if(cateval==cate1val){$(".cate2").attr("value","");$(".cate3").attr("value","")}}else{$(".next").attr("action","/case/caselist/");$(".cate1").attr("value","");$(".cate2").attr("value","");$(".cate3").attr("value","")}}});$(".category_select_1").click(function(){$(".cate1").attr("value",$(this).val())});$(".category_select_2").live("click",function(){if($(this).val()!=="请选择"){$(".cate2").attr("value",$(this).val())}});$(".category_select_3").live("click",function(){if($(this).val()!=="请选择"){$(".cate3").attr("value",$(this).val())}});$("#searchicon").click(function(){$("#searchbar").toggle()});$(".statue").click(function(){if($(this).val()!==""){$(".mold").show()}else{$(".mold").hide()}});if($(".hide-statue").val()){$(".statue").removeAttr("selected");$(".statue option[value="+$(".hide-statue").val()+"]").attr("selected",true);$(".mold").show();if($(".hide-mold").val()){$(".mold").removeAttr("selected");$(".mold option[value="+$(".hide-mold").val()+"]").attr("selected",true)}}if($(".cauthor").val()){$(".author").removeAttr("selected");$(".author option[value="+$(".cauthor").val()+"]").attr("selected",true)}if($(".cexecutor").val()){$(".executor").removeAttr("selected");$(".executor option[value="+$(".cexecutor").val()+"]").attr("selected",true)}$(".form_datetime").datetimepicker({format:"yyyy-mm-dd",autoclose:true,todayBtn:true,pickerPosition:"bottom-left",language:"zh-CN",minView:2});$(".icon-eye-open").click(function(){$("#myModal").modal("show");cpid=$(this).next().val();var url="/case/execlog/"+cpid;$.get(url,function(data,status){var datalist=eval("("+data+")");var num=datalist.length;$(".title").html("<h5>测试结果：共执行<span>"+(num-1)+"次</span>,通过<span>"+datalist[0].Pass+"次</span></h5>");recordhtml="<thead><tr>"+'<th width="15px">&nbsp</th>'+'<th width="88px">日期</th>'+'<th width="30px">执行人</th>'+'<th width="15px">结果</th>'+'<th width="94px">备注</th>'+"</tr></thead>";for(var i=1;i<num;i++){recordhtml+="<tr>"+"<td>#"+i+"</td>"+"<td>"+datalist[i].date+"</td>"+"<td>"+datalist[i].executor+"</td>"+"<td>"+datalist[i].result+"</td>"+"<td>"+(datalist[i].remark?datalist[i].remark:"")+"</td>"+"</tr>"
}$(".boxtable").html(recordhtml)})});$(".savebtn").click(function(){$(".savebtn").attr("disabled","true");i=1;j=0;var casejson=[];var dic={};var diclist=[dic];var mmid=[];var mchk=[-2];var mrank=[0];var flag=true;var m=0;var node=$('input[name="checklist"]:checked');var nlen=node.length;$(node).each(function(){var node=$(this).parent().parent();tdata=node.children();cm=$(this).parents(".cmodule");tmodule=cm.attr("value");tmrank=cm.attr("rank");mrank[i]=tmrank;if(tmodule==""||tmodule==undefined){if(mrank[i-1]!=tmrank){m--}tmodule=m}mchk[i]=tmodule;if(node.attr("class")=="mtr"){input=$.trim(tdata.eq(2).text());output=$.trim(tdata.eq(3).text());mname=$.trim(cm.find(".success").children().eq(1).text());if(mname.length<=0||mname.length>100){cm.find(".success").css("border","3px solid #f77");$(".savebtn").removeAttr("disabled");alert("模块名称为必填项，长度不能大于100个字符！");flag=false;return false}if(input.length>300||output.length>300||!input||!output){node.css("background-color","#ffecec");$(".savebtn").removeAttr("disabled");alert("用例输入、期望输出为必填项，长度不能大于100个字符！");flag=false;return false}else{datadic={"mname":mname,"mrank":cm.attr("rank"),"id":$(this).parent().parent().attr("value"),"precon":tdata.eq(1).text(),"action":input,"output":output,"priory":tdata.eq(4).text(),"rank":node.attr("rank")};if(mchk[i-1]!=tmodule){j=0;casejson=[];dic[tmodule]=casejson;casejson[j]=datadic}else{casejson[j]=datadic}}}else{mtrnode=(node.parent(".cmodule").find(".mtr").find('input[name="checklist"]:checked'));if(mtrnode.length==0){cmname=$.trim(cm.find(".success").children().eq(1).text());if(cmname.length>0&&cmname.length<=100){datadic={"mname":cmname,"mrank":cm.attr("rank"),"id":-3};j=0;casejson=[];casejson[j]=datadic;dic[tmodule]=casejson}else{node.css("border","3px solid #f77");$(".savebtn").removeAttr("disabled");alert("模块名称为必填项，长度不能大于30个字符！");flag=false;return false}}}i++;j++});if(flag==true){diclist=JSON.stringify(diclist);casedic={"datas":diclist};node=$('input[name="checklist"]:checked');if(diclist.length-4){$.post("/case/savecase/",casedic,function(data){var resp=eval("("+data+")");if(resp.message){node.removeAttr("checked");node.parent().parent().removeAttr("style");location.reload()}else{alert("保存失败，请重新保存！")}$(".savebtn").removeAttr("disabled")})}else{alert("请勾选需要保存的用例！");$(".savebtn").removeAttr("disabled")}}});$(".fileload").click(function(){$("#upload").modal("show")});$("#file_upload").uploadify({"debug":false,"swf":"/static/jquery/uploadify.swf","uploader":"/case/upload/","cancelImg":"/static/img/uploadify-cancel.png","auto":true,"multi":false,"removeCompleted":false,"fileTypeExts":"*.xlsx;*.xls;","fileTypeDesc":"Excel File","buttonText":"选择文件","onUploadStart":function(file){reminder_html="<p style = 'color:red;'>正在上传请耐心等待,不要关闭弹框~~</p>";$(".reminder").html(reminder_html)},"onSelectError":function(file,errorCode,errorMsg){switch(errorCode){case -100:alert("上传的文件数量已经超出系统限制的"+$("#file_upload").uploadify("settings","queueSizeLimit")+"个文件！");break;case -110:alert("文件 ["+file.name+"] 大小超出系统限制的"+$("#file_upload").uploadify("settings","fileSizeLimit")+"大小！");break;case -120:alert("文件 ["+file.name+"] 大小异常！");break;case -130:reminder_html="<p style = 'color:red;'>"+file.name+"  类型不正确,必须为xlsx、xls格式文件</p>";$(".reminder").html(reminder_html);break}},"onUploadSuccess":function(file,data,response){var result=eval("("+data+")");if(result.success){reminder_html="<p style = 'color:red;'>成功上传!</p>";$(".reminder").html(reminder_html)}else{reminder_html="<p style = 'color:red;'>"+result.message+"</p>";$(".reminder").html(reminder_html)}},"onUploadError":function(file,errorCode,errorMsg,errorString){reminder_html="<p style = 'color:red;'>"+file.name+" 上传失败: "+errorString+","+errorCode+"</p>";$(".reminder").html(reminder_html)},"onFallback":function(){reminder_html="<p style = 'color:red;'>您未安装FLASH控件,请安装FLASH控件后再试</p>";$(".reminder").html(reminder_html)},});$(".fileupload").click(function(){location.reload()})});